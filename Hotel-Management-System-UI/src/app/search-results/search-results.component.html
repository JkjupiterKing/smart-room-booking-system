<!-- Navigation Bar -->
<div *ngIf="isLoggedIn">
  <app-admin-navbar *ngIf="userRole === 'admin'"></app-admin-navbar>
  <app-user-navbar *ngIf="userRole === 'user'"></app-user-navbar>
</div>

<app-public-navbar
  *ngIf="!isLoggedIn"
  (loginClicked)="openLoginModal()"
  (registerClicked)="openRegisterModal()"
></app-public-navbar>

<div class="search-results-container">
  <div class="content">
    <div class="main-content">
      <div *ngIf="isLoading$ | async" class="loader">
        <p>Loading hotels...</p>
      </div>

      <div *ngIf="!(isLoading$ | async)">
        <div *ngIf="(filteredHotels$ | async) as hotels; else noResults">
          <h2 class="search-heading" *ngIf="hotels.length > 0">
            Here are some options for your search
          </h2>
          <div *ngIf="hotels.length > 0; else noResults" class="hotels-grid">
            <div
              *ngFor="let hotel of hotels"
              class="hotel-card"
              (click)="navigateToHotel(hotel.id)"
            >
              <img
                [src]="'data:image/jpeg;base64,' + hotel.imageBase64"
                alt="Photo of {{ hotel.name }}"
                class="hotel-image"
              />
              <div class="hotel-details">
                <h3 class="hotel-name">{{ hotel.name }}</h3>
                <p class="hotel-location">
                  {{ hotel.location.city }}, {{ hotel.location.country }}
                </p>
                <div class="hotel-rating">
                  <span *ngFor="let i of getStarArray(hotel.rating)" class="star"
                    >&#9733;</span
                  >
                  <span class="reviews">(120 reviews)</span>
                </div>

                <div class="hotel-amenities">
                  <div class="amenity">
                    <i class="fas fa-concierge-bell"></i>
                    <span>Room Service</span>
                  </div>
                  <div class="amenity">
                    <i class="fas fa-swimmer"></i>
                    <span>Pool Access</span>
                  </div>
                  <div class="amenity">
                    <i class="fas fa-mountain"></i>
                    <span>Mountain View</span>
                  </div>
                </div>

                <div class="price-container">
                  <p class="hotel-price">
                    <strong>â‚¹{{ hotel.price | number : "1.2-2" }}</strong> /
                    night
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <ng-template #noResults>
        <div class="no-results">
          <p>No hotels found for your search.</p>
        </div>
      </ng-template>
    </div>

    <div class="sidebar">
      <div class="filter-card">
        <div class="filter-header">
          <h3>Filters</h3>
          <a href="#" class="clear-link" (click)="clearFilters(); $event.preventDefault()">Clear</a>
        </div>

        <div class="filter-group">
          <h4>Room Type</h4>
          <div
            class="filter-option"
            *ngFor="let roomType of allRoomTypes"
          >
            <input
              type="checkbox"
              [id]="'room-type-' + roomType.id"
              [checked]="roomTypeFilters[roomType.name]"
              (change)="onRoomTypeFilterChange(roomType.name, $event)"
            />
            <label [for]="'room-type-' + roomType.id">{{ roomType.name }}</label>
          </div>
        </div>

        <div class="filter-group">
          <h4>Rating</h4>
          <div class="filter-option" *ngFor="let rating of [5, 4, 3]">
            <input
              type="checkbox"
              [id]="'rating-' + rating"
              [checked]="ratingFilters[rating]"
              (change)="onRatingFilterChange(rating, $event)"
            />
            <label [for]="'rating-' + rating">{{ rating }} Star</label>
          </div>
        </div>

        <div class="filter-group">
          <h4>Price Range</h4>
          <div class="filter-option">
            <input
              type="checkbox"
              id="price-1"
              [checked]="priceFilters['0-500']"
              (change)="onPriceFilterChange('0-500', $event)"
            />
            <label for="price-1">$0 to 500</label>
          </div>
          <div class="filter-option">
            <input
              type="checkbox"
              id="price-2"
              [checked]="priceFilters['500-1000']"
              (change)="onPriceFilterChange('500-1000', $event)"
            />
            <label for="price-2">$500 to 1000</label>
          </div>
          <div class="filter-option">
            <input
              type="checkbox"
              id="price-3"
              [checked]="priceFilters['1000-2000']"
              (change)="onPriceFilterChange('1000-2000', $event)"
            />
            <label for="price-3">$1000 to 2000</label>
          </div>
          <div class="filter-option">
            <input
              type="checkbox"
              id="price-4"
              [checked]="priceFilters['2000-3000']"
              (change)="onPriceFilterChange('2000-3000', $event)"
            />
            <label for="price-4">$2000 to 3000</label>
          </div>
        </div>

        <div class="filter-group">
          <h4>Sort By</h4>
          <div class="filter-option">
            <input
              type="radio"
              id="sort-low-high"
              name="sort"
              value="priceLowToHigh"
              (change)="onSortChange($event)"
              [checked]="sortBy === 'priceLowToHigh'"
            />
            <label for="sort-low-high">Price Low to High</label>
          </div>
          <div class="filter-option">
            <input
              type="radio"
              id="sort-high-low"
              name="sort"
              value="priceHighToLow"
              (change)="onSortChange($event)"
              [checked]="sortBy === 'priceHighToLow'"
            />
            <label for="sort-high-low">Price High to Low</label>
          </div>
          <div class="filter-option">
            <input
              type="radio"
              id="sort-newest"
              name="sort"
              value="newestFirst"
              (change)="onSortChange($event)"
              [checked]="sortBy === 'newestFirst'"
            />
            <label for="sort-newest">Newest First</label>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div *ngIf="isLoginModalOpen" class="modal">
  <div class="modal-content">
    <h2>Login</h2>
    <form #loginForm="ngForm" (ngSubmit)="onLoginSubmit(loginForm)">
      <div>
        <label for="username">Username:</label>
        <input
          type="text"
          id="username"
          name="username"
          ngModel
          required
          #username="ngModel"
        />
        <div *ngIf="username.invalid && username.touched">
          <small class="error">Username is required.</small>
        </div>
      </div>
      <div>
        <label for="password">Password:</label>
        <input
          type="password"
          id="password"
          name="password"
          ngModel
          required
          #password="ngModel"
        />
        <div *ngIf="password.invalid && password.touched">
          <small class="error">Password is required.</small>
        </div>
      </div>
      <br />
      <button type="submit" [disabled]="loginForm.invalid">Login</button>
    </form>
    <br />
    <button (click)="closeLoginModal()">Close</button>
  </div>
</div>

<!-- Register Modal -->
<div *ngIf="isRegisterModalOpen" class="modal">
  <div class="modal-content">
    <h2>Register</h2>
    <form #registerForm="ngForm" (ngSubmit)="onRegisterSubmit(registerForm)">
      <div>
        <label for="username">Username:</label><br />
        <input type="text" id="username" name="username" ngModel required />
        <div
          *ngIf="
            registerForm.form.controls['username']?.invalid &&
            registerForm.form.controls['username']?.touched
          "
        >
          <small class="error">Username is required.</small>
        </div>
      </div>
      <div>
        <label for="email">Email:</label><br />
        <input type="email" id="email" name="email" ngModel required />
        <div
          *ngIf="
            registerForm.form.controls['email']?.invalid &&
            registerForm.form.controls['email']?.touched
          "
        >
          <small class="error">Email is required.</small>
        </div>
        <div
          *ngIf="
            registerForm.form.controls['email']?.touched &&
            registerForm.form.controls['email']?.valid &&
            !registerForm.form.controls['email'].value.endsWith('@gmail.com')
          "
        >
          <small class="error">Please enter a valid email</small>
        </div>
      </div>
      <div>
        <label for="password">Password:</label><br />
        <input
          type="password"
          id="password"
          name="password"
          ngModel
          required
          #passwordInput="ngModel"
          pattern="^(?=.*[A-Za-z])(?=.*[0-9]).{6,}$"
        />
        <div
          *ngIf="
            passwordInput.invalid &&
            (passwordInput.dirty || passwordInput.touched)
          "
        >
          <small *ngIf="passwordInput.errors?.['required']" class="error">
            Password is required.
          </small>
          <small *ngIf="passwordInput.errors?.['pattern']" class="error">
            Password must contain both letters and numbers.
          </small>
        </div>
      </div>
      <br />
      <button type="submit" [disabled]="registerForm.invalid">Register</button>
    </form>
    <br />
    <button (click)="closeRegisterModal()">Close</button>
  </div>
</div>
